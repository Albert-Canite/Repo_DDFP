# YOLO-Tiny 回归训练停滞诊断报告（全面修订版）

## 一、已确认的根因（最高优先级）
1. **全局平均池化抹掉位置信息**：主干下采样到 16×16 后立即 `AdaptiveAvgPool2d((1,1))`，再用 MLP 回归 4 个数，导致网络几乎平移不变，仅能输出与输入位置无关的常量框，完全无法学习真实坐标。【F:experiments/rsna_regression.py†L123-L214】
   - **修复方向（至少择一）**：
     - 去掉全局池化，保留空间分辨率：将 16×16×256 展平送轻量 Transformer/MLP，或改用 1×1/3×3 conv + flatten，让梯度携带网格位置信号。
     - 显式注入坐标：在特征图上拼接 normalized x/y 坐标或使用 CoordConv/可学习位置编码。
     - 采用多栅格检测头：将特征图切分网格，每格预测相对偏移/尺度，保证坐标系与标签一致。
   - **验证**：移除池化后，检查预测中心/宽高的批内方差是否显著增大，曲线是否摆脱平台期。

## 二、需重点核查的高风险环节
1. **数据与标注变换**：标注在读取后归一化到 0–1，翻转、仿射后按像素坐标重算并裁剪。【F:experiments/rsna_regression.py†L27-L98】逻辑表面自洽，但易有隐藏错位。
   - **行动**：在 `__getitem__` 后（含增强）把框反归一化到 512×512 像素，叠加到图像可视化，逐样本核对；同时记录是否出现负宽高/越界。

2. **预测分布塌缩检查**：当前症状（常量框、IoU≈0.1–0.2）典型于输出方差趋零。
   - **行动**：
     - 训练时记录每批 `center`/`size` 的均值方差，若方差接近 0 立即报警。
     - 统计特征图均值/方差，排查是否在早期就被激活/BN 拉平。
     - 绘制若干 epoch 的预测与 GT 对比，看是否随时间靠近。

3. **坐标系一致性**：训练时预测角点与 GT 都经过 `order_and_clip_boxes` 排序裁剪，但中心/宽高损失直接用 Sigmoid 输出，可能与裁剪后的角点不一致，引入梯度噪声。【F:experiments/rsna_regression.py†L380-L389】【F:experiments/rsna_regression.py†L500-L532】
   - **行动**：基于裁剪后的框重算中心/尺寸再参与损失，或约束 Sigmoid 输出范围与裁剪逻辑一致；同时验证推理/评估阶段是否使用同一坐标约定。

4. **反向与优化链路**：训练循环每步调用 `loss.backward()`、`clip_grad_norm_`、`opt.step()`，但需确认无早退分支、无 `no_grad` 误用。【F:experiments/rsna_regression.py†L369-L424】
   - **行动**：
     - 监控梯度范数和参数更新量（如权重直方图或 L2 差分）；若接近 0，排查学习率/权重衰减/梯度裁剪是否过强。
     - 单步检查：打印某层权重在 `opt.step()` 前后差值是否非零。

5. **调度与超参交互**：
   - Warmup 手动调 lr，CosineAnnealingLR 仍从 epoch0 计步，warmup 结束时余弦已前进数步，可能导致 lr 曲线低于预期。【F:experiments/rsna_regression.py†L345-L455】
   - 小批 BN 噪声大，批量 4 难以稳定统计；全局 `torch.use_deterministic_algorithms(True)` 减少随机性，可能降低增强多样性。【F:core/config.py†L45-L86】
   - **行动**：用 SequentialLR/LinearLR 实现真实 warmup，再接 Cosine；考虑切换 GroupNorm/冻结 BN 均值方差；按需放宽确定性设置或增加 worker 随机性。

6. **Loss 设计与权重**：初期 IoU 可能全为 0，只有 L1 驱动，收敛慢。
   - **行动**：前几 epoch 降低 IoU 权重或使用 GIoU/DIoU/CIoU；将中心/尺寸与角点 L1 分开监控，观察梯度是否冲突。

7. **数据量与采样**：若 2000/400 的拆分或种子导致样本重复、单一场景，网络易学到“平均框”。
   - **行动**：检查划分索引、开启 `shuffle`，必要时扩充数据或使用更丰富的增强（但确保框同步）。

## 三、整体改进方案（可执行蓝图）
1. **重构头部保持空间信息**：移除全局池化，改为保留 16×16 特征，使用卷积/Transformer 网格预测；为量化路径准备时保持相同张量形状以复用权重。
2. **统一坐标系与损失**：所有损失使用同一裁剪/排序后的框；IoU 换为 GIoU/DIoU；记录各分支 loss 曲线排查冲突。
3. **强化可视化与监控**：新增调试钩子输出增强后图像+框、预测方差、特征方差、梯度范数、学习率曲线，早期发现塌缩或调度异常。
4. **稳健训练配置**：调大批次或替换 BN，重新校准 warmup+cosine，适当降低权重衰减/梯度裁剪阈值，确认 `optimizer.step()` 发生有效更新。
5. **验证闭环**：在 FP32/量化各链路上复用统一的解码/后处理，确保评估坐标系一致，并对比修复前后的 MAE/IoU 改善幅度。
